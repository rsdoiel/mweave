<!DOCTYPE html>
<html>
    <head>
        <title>MWeave</title>
    </head>
    <body>
        <header><h1>MWeave</h1> an experiment in simplified literate programming.</header>
        <section><h1>Markdown Weave</h1>
<h2>Rational</h2>
<p>This is an experiment in <a href="http://en.wikipedia.org/wiki/Literate_programming">literarte programming</a>
using Markdown as the markup language.  While it does not attempt all the ideas put forward
by <a href="http://www.literateprogramming.com/">Donald Knuth</a> it proceed from the point of view that
that creating a document that is human readable helps clarify thinking on what needs to be executed
by the computer. While the core of computers have not changed (i.e. they still have volitile memory,
non-volitile memory and one or more computational units) the tools, languages and manner in which
they are applied has grown. Today there are many more programming languages. The distinction between
instructional languages and &quot;professional&quot; languages is largely gone. Another change is the 
breadth of tools available for building applications. Many editors today have built in linters,
color coding of the programming text and live views of the results. Additionally the notion
of typesetting has morphed.  When Knuth first wrote is tools, his <a href="http://en.wikipedia.org/wiki/TeX">TeX</a>
was the masterful land capable of generating primary documentation via paper printouts.  Today
were are seen computer documentation spread via the web rather then reams of paper. Still the idea
of writing prose and code has strong attraction. </p>
<h2>Weave/Tangle reconsidered</h2>
<p>One of the challenges I repeatily run into is transmitting to my colleagues my understanding when
creating web APIs and other systems.  It is more then simple code documentation I would get form
a system like javadoc, doxygen, or yuidoc. Those tools are very helpful when you already know
how things work (e.g. looking up a class method, looking inside how a method was written). What
is missing is the narrative in how the system came about and the tutorials need to get familiar
with the system.  I have adopted the common &quot;best practices&quot; of including a README.md, an INSTALLATION.md
and assortment of example usages and usually several additional Markdown documents explaining 
things.  This is helpful when the program or API is first deployed.  Keeping them currrent is
difficult if I am the only coding. Expecting others to keep them current is not very reasonable.
Not only would they need to update the source code they need to find all the places I might have
talked about it in my prose. So why not stick the code in my prose?  This is done all the time
on github with documentation written in Markdown.  The only peice missing is generating the
program code from the markdown documents.  <em>mweave.js</em> is an attempt to explore that. It is
far simpler then learning the markup of <a href="http://www.literateprogramming.com">cweb</a>.  It can
be applied equally to languages commonly shared on Github. It should be a small tool
in the toolchain that can be leverage to get us a little further down the road to maintainable
source code.</p>
<p>My experiment, <em>mweave.js</em>, differs from Literate Programming definition in a couple of ways</p>
<ul>
<li>No change to the syntax of Markdown as practiced on Github</li>
<li>No Macro language</li>
<li>Order of explanation DOES reflect the output of the files you generate</li>
<li>The rendered document includes the code examples from &quot;code&quot; blocks that are immediately precede by links</li>
<li>The render program includes any embedded commments as they were in the code blocks from the source file</li>
<li><em>mweave.js</em> is intended not as a complete system but another helper tool like <em>jslint</em> or <em>markdown</em></li>
<li>The code generated should look like the code in the original document just out-dented by 4 spaces</li>
<li>I should be able to use this approach to bootstrap a better <em>mweave.js</em> tool</li>
</ul>
<h2>Running mw-bootstrap.js on Markdown-Weaver.md</h2>
<p>There is a shell script that generate <em>mw-bootstrap.js</em>. It relies on <em>bash</em> and <em>vi</em>.
You can run that script with the following command--</p>
<pre><code class="language-Shell">    bash reboot.sh</code></pre>
<h3>reboot.sh aside</h3>
<p>Ideally I would like to beable to rebuild the system into useable state
from a simple application of the bootstrap program listed in <a href="README.md">README.md</a>.
This shell script illustrates the commands need to build the system from scratch.</p>
<p><em>reboot.sh</em> does the following things.</p>
<p><a href="reboot.sh">reboot.sh</a></p>
<pre><code class="language-Shell">    #!/bin/bash

    #
    # Generate JavaScript source files.
    #
    echo &quot;This is a shell script executing the commands to bootstrap mw.js&quot;
    echo &quot;Running the vi command to pull mw-bootstrap.js out of README.md&quot;
    vi -e -c &quot;20,67wq! mw-bootstrap.js&quot; README.md
    sed -e &quot;s/    //&quot; -i mw-bootstrap.js
    echo &quot;Running mw-bootstrap.js on Markdown-Weave.md&quot;
    node mw-bootstrap.js Markdown-Weave.md &gt; tmp.sh
    echo &quot;Running the suggested vi commands to make mw.js and mw_test.js&quot;
    . tmp.sh
    rm tmp.sh

    #
    # Setup and run some testing.
    #
    if [ -f &quot;mw.js&quot; ];then
        echo &quot;Found mw.js&quot;
    else
        echo &quot;Missing mw.js, something went wrong.&quot;
        exit 1
    fi
    if [ -f &quot;mw_test.js&quot; ]; then
        node mw_test.js
    else
        echo &quot;Missing mw_test.js, something went wrong.&quot;
        exit 1
    fi

    if [ -f &quot;cli.js&quot; ] &amp;&amp; [ -f &quot;HelloWorld.md&quot; ]; then
        node cli.js HelloWorld.md
        node test_helloworld.js
    fi</code></pre>
<p>If Markdown-Weave.md was going to be run with <em>ms.js</em> then I would have created the above
script in multiple blocks.  <em>mw-bootstrap.js</em> does not support that so this file is less literate
in that sense.</p>
<p>Here is the command which I plan to used to build <em>mw.js</em> -</p>
<p>To generate <em>mw.js</em> try the following command.</p>
<pre><code class="language-Shell">    node mw-bootstrap.js Markdown-Weave.md</code></pre>
<h2>mw.js</h2>
<p>Ok, so here we go. Let us see if I can implement <em>mw.js</em> from <em>mw-bootstrap.js</em> processing
this file.   mw.js creates an constructor called <strong>Weave()</strong>. <strong>Weave()</strong> generates a JavaScript
object with a parse method and render method. <strong>Weave.parse()</strong> accepts Markdown source code as a string
and generates a new object which has properties with filenames to write an a list (i.e.
Array) of start and end line numbers to use in constructing the target file. <strong>Weave.render()</strong>
takes the original Markdown source code along with the parse results and renders a new object
containing properties corresponding with the extracted source code. The object will need further
processing to be written out to disc.</p>
<p><a href="mw.js">mw.js</a></p>
<pre><code class="language-JavaScript">    /**
     * mw.js - Markdown Weave, an exploration in Markdown using 
     * literate programming concepts.
     * @author R. S. Doiel, &lt;rsdoiel@gmail.com&gt;
     */
    /*jslint indent: 4 */
    /*global exports */
    function Weave() {
        return {
            parse: function (source) {
                var lines = source.split(&quot;\n&quot;),
                    filename = null,
                    outputs = {},
                    start_cut = 0,
                    end_cut= 0,
                    i = 0,
                    j = 0;

                for (i = 0; i &lt; lines.length; i += 1) {
                    line = lines[i];
                    check = line.trim();
                    if (i &lt; lines.length - 2 &amp;&amp;
                            lines[i + 1].indexOf(&quot;```&quot;) === 0 &amp;&amp;
                            check[0] === &#39;[&#39; &amp;&amp; check[check.length - 1] === &#39;)&#39;) {
                        // Now skip ahead to lines of actual code.
                        i += 2;
                        start_cut = check.lastIndexOf(&#39;(&#39;) + 1;
                        end_cut = check.lastIndexOf(&#39;)&#39;);
                        filename = line.substr(start_cut, end_cut - start_cut);
                        if (typeof outputs[filename] === &quot;undefined&quot;) {
                            outputs[filename] = [];
                        }
                        // I am storing line numbers, not index into lines.
                        // Start and End points are inclusive.
                        outputs[filename].push({start: i + 1, end: -1});
                    } else if (filename !== null &amp;&amp; line.indexOf(&quot;```&quot;) === 0) {
                        /* Find the last entry and add the end point */
                        j = outputs[filename].length - 1;
                        outputs[filename][j].end = i;
                        filename = null;
                    }
                }
                return outputs;
            },
            render: function (source, parsed) {
                var lines = source.split(&quot;\n&quot;),
                    filenames = Object.keys(parsed),
                    outputs = {};

                function catSource(points) {
                    var output = [];
                    points.forEach(function (point) {
                        var i, start, end, outdent = 4;
                        // Convert from line numbers to array index
                        start = point.start - 1;
                        end = point.end - 1;
                        // end is inclusive.
                        for (i = start; i &lt;= end &amp;&amp; i &lt; lines.length; i += 1) {
                            outdent = 0;
                            if (lines[i].indexOf(&quot;    &quot;) === 0) {
                                outdent = 4;
                            } else if (lines[start].indexOf(&quot;\t&quot;) === 0) {
                                outdent = 1;
                            }
                            output.push(lines[i].substr(outdent));
                        }
                    });
                    return output.join(&quot;\n&quot;);
                }

                filenames.forEach(function (filename) {
                    outputs[filename] = catSource(parsed[filename]);
                });
                return outputs;
            }
        };
    }

    if (typeof exports !== &quot;undefined&quot;) {
        exports.Weave = Weave;
    }</code></pre>
<h3>mw_test.js</h3>
<p>Here is some test code for see if mw.js works. This code relies on the YUI3 test module.</p>
<p><a href="mw_test.js">mw_test.js</a></p>
<pre><code class="language-JavaScript">    /**
     * mw_test.js - Test code for mw.js which was generated via mw-bootstrap.js.
     * @author R. S. Doiel, &lt;rsdoiel@gmail.com&gt;
     * copyright (c) 2013 all rights reserved
     * Licensed under BSD 2-clause license. See http://opensource.org/licenses/BSD-2-Clause
     */
    /*jslint node: true, indent: 4 */
    var YUI = require(&quot;yui&quot;).YUI,
        fs = require(&quot;fs&quot;),
        mw = require(&quot;./mw&quot;);

    YUI({
       debug: true,
       useSync: true
    }).use(&quot;test&quot;, function (Y) {
        var testCase;

        testCase = new Y.Test.Case({
            name: &quot;Simple testing for mw.js&quot;,
            &quot;Should parse Markdown-Weave.md and yeild a new object&quot;: function () {
                var weave = new mw.Weave(),
                    source = fs.readFileSync(&quot;Markdown-Weave.md&quot;).toString(),
                    results = weave.parse(source);

                Y.Assert.isObject(results);
                Y.Assert.isObject(results[&quot;mw.js&quot;]);
                Y.Assert.isObject(results[&quot;mw.js&quot;][0]);
                // Remember array of lines cound from zero. End is inclusive.
                Y.Assert.areSame(134, results[&quot;mw.js&quot;][0].start);
                Y.Assert.areSame(214, results[&quot;mw.js&quot;][0].end);

                // Now try running on HelloWorld.md
                source = fs.readFileSync(&quot;HelloWorld.md&quot;).toString();
                results = weave.parse(source);
                Y.Assert.areSame(8, results[&quot;helloworld.js&quot;][0].start);
                Y.Assert.areSame(8, results[&quot;helloworld.js&quot;][0].end);
            },
            &quot;Should render  a parsed object into a new object.&quot;: function () {
                var weave = new mw.Weave(),
                    source = fs.readFileSync(&quot;Markdown-Weave.md&quot;).toString(),
                    obj = weave.parse(source),
                    results = weave.render(source, obj);

                Y.assert(source.length &gt; 0, &quot;Should have some markdown source&quot;);
                Y.Assert.isObject(obj[&quot;cli.js&quot;]);
                Y.assert(obj[&quot;cli.js&quot;][0].start &gt; 0);
                Y.assert(obj[&quot;cli.js&quot;][0].end &gt; 0);

                Y.Assert.isObject(results);
                Y.Assert.isString(results[&quot;cli.js&quot;]);

                // Now test our simple HelloWorld.md
                source = fs.readFileSync(&quot;HelloWorld.md&quot;).toString();
                obj = weave.parse(source);
                results = weave.render(source, obj);
                Y.Assert.isString(results[&quot;helloworld.js&quot;]);
                Y.Assert.areEqual(&#39;console.log(&quot;Hello World&quot;);&#39;, results[&quot;helloworld.js&quot;]);  
            }
        });

        Y.Test.Runner.add(testCase);
        Y.Test.Runner.run();
     });</code></pre>
<h3>design choices</h3>
<p>So why stop just before rendering text to disc? Because it may be helpful to use <em>mweave.js</em> with outer 
browser based tools (e.g. CodeMirror, Ace). Additionally NodeJS (where this will likely run) resents
an event module for I/O and leveraging that in a wrapper of this library (e.g. <em>cli.js</em>) makes the most
sense to me at this stage.</p>
<h2>Biulding command-line tool</h2>
<p>The command line tool provides the bindings to file IO and processing of command line options.</p>
<p><a href="cli.js">cli.js</a></p>
<pre><code class="language-JavaScript">    #!/usr/bin/env node
    /**
     * cli.js - this is the command line tool for mweave command. It includes
     * binding mw.js to the file system.
     * @author R. S. Doiel, &lt;rsdoiel@gmail.com&gt;
     * copyright (c) 2013 all rights reserved
     */

    var fs = require(&quot;fs&quot;),
        path = require(&quot;path&quot;),
        handlebars = require(&quot;handlebars&quot;),
        marked = require(&quot;marked&quot;),
        opt = require(&quot;opt&quot;).create(),
        mw = require(&quot;./mw&quot;),
        markdownFilename = &quot;&quot;,
        documentDirectory = &quot;&quot;,
        handlebarsTemplate = &quot;&quot;,
        renderHTML = false;

    opt.optionHelp(&quot;USAGE mweave MARKDOWN_FILENAME&quot;,
        &quot;SYNOPSIS: Process the markdown file listed on the command line and render any&quot; +
        &quot;source files defined in it.&quot;,
        &quot;OPTIONS&quot;,
        &quot; copyright (c) 2013 all rights reserved\n&quot; +
        &quot; Released under the BSD 2-clause license\n&quot; + 
        &quot; See : http://opensource.org/licenses/bsd-license.php\n&quot;);


    opt.consume();
    opt.option([&quot;-i&quot;, &quot;--input&quot;], function (param) {
        if (param) {
            markdownFilename = param.trim();
        }
        opt.consume(param);
    }, &quot;Set the Markdown filename to process.&quot;);

    opt.option([&quot;-d&quot;, &quot;--directory&quot;], function (param) {
        if (param) {
            documentDirectory = param.trim();
        }
        opt.consume(param);
    }, &quot;Set the document directory to write to.&quot;);

    opt.option([&quot;-b&quot;, &quot;--handlebars&quot;], function (param) {
        if (param) {
            handlebarsTemplate = param.trim();
        }
        opt.consume(param);
    }, &quot;Use the handlebars template when rendering HTML.&quot;);
    opt.option([&quot;-o&quot;, &quot;--output&quot;], function (param) {
        renderHTML = true;
        if (param) {
            htmlFilename = param.trim();
        }
        opt.consume(param);
    }, &quot;Render HTML from Markdown document as filename&quot;);

    opt.option([&quot;-h&quot;, &quot;--help&quot;], function (param) {
        opt.usage();
    }, &quot;Generate this help page.&quot;);

    var argv = opt.optionWith(process.argv);

    if (argv[2] !== undefined &amp;&amp; markdownFilename === &quot;&quot;) {
        markdownFilename = argv[2];
    }

    if (argv[3] !== undefined &amp;&amp; htmlFilename === &quot;&quot;) {
        htmlFilename = argv[3];
    }

    fs.readFile(markdownFilename, function (err, buf) {
        var obj,
            source,
            template_source,
            html,
            weave = new mw.Weave();

        if (err) {
            opt.usage(err, 1);
        }
        source = buf.toString();
        obj = weave.parse(source);
        results = weave.render(source, obj);

        Object.keys(results).forEach(function (filename) {
            console.log(&quot;Writing&quot;, path.join(documentDirectory, filename));
            fs.writeFile(path.join(documentDirectory, filename), results[filename]);
        });
        if (renderHTML === true) {
            marked.setOptions({
                gfm: true,
                tables: true,
                breaks: false,
                pedantic: false,
                sanitize: true,
                smartLists: true,
                langPrefix: &#39;language-&#39;,
                highlight: function(code, lang) {
                    if (lang === &#39;js&#39;) {
                        return highlighter.javascript(code);
                    }
                    return code;
                }
            });
            html = marked(source);
            if (handlebarsTemplate !== &quot;&quot;) {
                template_source = fs.readFileSync(handlebarsTemplate).toString();
                template = handlebars.compile(template_source);
                html = template({content: html});
            }
            if (htmlFilename !== &quot;&quot;) {
                console.log(&quot;Writing&quot;, path.join(documentDirectory, htmlFilename));
                fs.writeFile(path.join(documentDirectory, htmlFilename), html);
            } else {
                process.stdout.write(html);
            }
        }
    });</code></pre>
<h1>Misc support scripts</h1>
<h2>Node packaging of <em>mweave.js</em></h2>
<p><a href="package.json">package.json</a></p>
<pre><code class="language-JavaScript">    {
        &quot;name&quot;: &quot;mweave&quot;,
        &quot;version&quot;: &quot;0.0.1&quot;,
        &quot;description&quot;: &quot;This is an experiment in using Markdown and some concepts from literate programming.&quot;,
        &quot;main&quot;: &quot;mw.js&quot;,
        &quot;bin&quot;: {
            &quot;mweave&quot;: &quot;./cli.js&quot;
        },
        &quot;scripts&quot;: {
            &quot;test&quot;: &quot;mw_test.js&quot;
        },
        &quot;optionalDependencies&quot;: {
            &quot;yui&quot;: &quot;3.10.x&quot;,
            &quot;yuitest&quot;: &quot;0.7.x&quot;
        },
        &quot;dependencies&quot;: {
            &quot;handlebars&quot;: &quot;1.0.x&quot;,
            &quot;marked&quot;: &quot;0.2.x&quot;,
            &quot;opt&quot;: &quot;0.1.x&quot;
        },
        &quot;repository&quot;: {
            &quot;type&quot;: &quot;git&quot;,
            &quot;url&quot;: &quot;git@github.com:rsdoiel/mweave.git&quot;
        },
        &quot;keywords&quot;: [
          &quot;markdown&quot;,
          &quot;weave&quot;,
          &quot;javascript&quot;
        ],
        &quot;engines&quot;: {
            &quot;node&quot;: &quot;0.10.x&quot;,
            &quot;npm&quot;: &quot;1.2.x&quot;
        },
        &quot;author&quot;: &quot;R. S. Doiel&quot;,
        &quot;license&quot;: &quot;BSD&quot;,
        &quot;readmeFilename&quot;: &quot;README.md&quot;
    }</code></pre>
</section>
        <footer></footer>
    </body>
</html>
